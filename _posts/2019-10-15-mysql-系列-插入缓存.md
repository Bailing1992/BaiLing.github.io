---
layout: post
title: "Mysql 系列 插入缓存"
subtitle: 'Mysql 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - mysql
---
> 带来存储引擎性能上的提升.
## 背景：
在InnoDB存储引擎中，主键是行唯一的标识符，InnoDB是基于主键的聚簇索引。通常应用程序中行纪录的插入顺序是按照主键递增的顺序进行插入的。因此，插入聚集索引一般是顺序的，不需要磁盘的随机读写。对于非聚簇的辅助索引的叶子节点的插入不再是顺序的了（InnoDB非聚簇索引的叶子节点的值不再是行，而是指向了主键索引），这是就需要离散的访问非聚簇索引页，由于随机读取的存在而导致了插入操作的性能下降。 

## Insert Buffer作用：解决非聚集索引写性能问题.  
对于非聚集类索引的插入和更新操作，不是每一次直接插入到索引页中，而是先判断插入的非聚集索引页是否在缓存池中，若在则直接插入。若不在，则先放入到一个插入缓存对象中。具体做法是：如果该索引页在缓冲池中，直接插入；否则，先将其放入插入缓冲区中，再以一定的频率和索引页合并。这时，通常可以将同一个索引页中的多个插入合并到一个IO操作中，大大提高写性能。


> 聚集索引和非聚集索引的根本区别是表记录的排列顺序与索引的排列顺序是否一致.  
聚集索引表记录的排列顺序与索引的排列顺序一致（查询速度快 修改速度较慢).  
非聚集索引指定了表中记录的逻辑顺序，但记录的物理顺序和索引的顺序不一致

Insert Buffer的数据结构是一个 B+ 树。在现版本中，全局只有一颗B+树，负责对所有的表的辅助索引进行insert Buffer。这颗B+树放在共享表空间中。其非叶子节点存放的是查询的search key(键值)

**merge insert buffer 的操作可能发生在：**
1. 辅助索引页被读取到缓存池中.
2. Insert Buffer Bitmap页追踪到该辅助索引页已无可用空间时
3. Master Thread


## change buffer
对Insert Buffer 的升级，InnoDB可以对DML操作（INSERT、DELETE、UPDATE）都进行缓存，分别是INSET buffer，Delete buffer，purge buffer.

## 适用条件：   
辅助索引 非唯一索引
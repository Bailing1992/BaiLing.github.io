---
layout: post
title: "MySQL 系列 行锁"
subtitle: 'MySQL 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - MySQL
---

## 行锁
InnoDB 存储引擎有 3 种 行锁算法：
* Record Lock: 单个行记录上的锁
* Gap lock: 间隙锁，锁定一个范围，但不包括记录本身。Gap 锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况
* Next-key lock: 锁定一个范围，并且锁定记录本身。

> Record Lock 总是会去锁住索引记录。存在多个索引时，需要分别进行加锁。如果 InnoDB 存储引擎表在建立的时候没有设置任何一个索引，那么InnoDB 存储引擎会使用隐式的主键来进行锁定

> Next-key lock 是结合了 Gap Lock 和 Record Lock 的一种锁定算法。 InnoDB 对于行的查询都是采用该方法，主要目的是解决幻读的问题

> 当查询的索引是唯一索引时，InnoDB 储存引擎会对 Next-key Lock 进行优化，将其降级为 Record Lock，即仅锁住索引本身，而不是范围。   


对于辅助索引，加 Next-key Lock，除此之外，还会对辅助索引的下一个键值加上Gap Lock。**Gap 锁的作用是为了阻止多个事务将记录插入到同一范围内，而这会导致幻读问题的产生。**       

在 InnoDB 存储引擎中，对于 Insert 的操作，其会检查插入记录的下一条记录是否被锁定，若已经被锁定，则不允许查询。


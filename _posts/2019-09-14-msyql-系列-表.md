---
layout: post
title: "Mysql 系列 表"
subtitle: 'Mysql 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - mysql
---

> 表是关于特定实体的数据集合，也是关系型数据库模型的核心。
* 表的逻辑存储及实现
* 表的物理存储特征，即数据在表中是如何组织和存放的

## 概念
#### 索引组织表
每张表都有一个主键，表根据主键顺序组织存放。数据即索引，索引即数据。      
> 主键的选择或创建:      
* 选择表中第一个定义的非空唯一索引
* 创建一个6字节大小的指针   

#### 逻辑存储结构：    
所有数据都被逻辑地存放在一个空间中，称为表空间。表空间由段、区、页组成。InnoDB 存储引擎的逻辑存储结构如图：  
![逻辑存储结构](/img/mysql/tablespace.png)      
**表空间**    
逻辑结构的最高层，所有数据都存放在表空间中.   
* 共享表空间：默认情况下，InnoDB存储引擎有一个共享表空间，即所有数据都存放在这个表空间中
* 独立表空间：用户启动了innodb_file_per_table，每张表内的数据可以单独放到一个表空间中
> 独立表空间只存放数据、索引和插入缓存bitmap页。其他的数据，如undo log(回滚信息)、插入缓存索引页、系统事务信息、二次写缓存等还是存放在共享表空间中

**段**       
表空间由各个段组成:
* 数据段：即 B+ 树的叶子节点
* 索引段：即 B+ 树的非索引节点
* 回滚段      
   
**区**    
由连续页组成的空间，在任何情况下每个区的大小都是 1MB。    
*在默认情况下，innodb存储引擎页的大小为16kB，即一个区中一共有64个连续的页*    
在用户启动了参数 innodb_file_per_table后，在每个段开始时，先用 32个页大小的碎片页来存放数据，在使用完这些页之后才是64个连续页的申请。    

**页**    
页是innoDB磁盘管理的最小单位，默认每个页的大小为16KB，可通过innodb_page_size将页的大小设置为4K、8K、16K   

**行**    
InnoDB存储引擎是面向列的，也就是数据是按行进行存放的。每个页允存放的行记录有硬性规定，最多允许存放16KB/2-200 = 7992行的记录。     

#### 数据页结构
InnoDB 数据页由以下7个部分组成：
* file header 文件头
* page header 页头
* infimun 和 supernum records： infimum是比该页中任何主键值都要小的值，supernum 指比任何可能大的值还要大的值。
* user records用户记录，即行记录
* free space 空闲空间
* page directory 页目录： 存放了记录的相对位置
* file trailer 文件结尾目录
其中file header、page header、file trailer的大小是固定的，分别为38、56、8字节，这些空间用来标记该页的一些信息。
user records、free spare、page directory这些部分为实际的行记录存储空间，因此大小是动态的

#### 行记录的格式（行记录的组织规则）    
记录是以行的形式存储的，页中保存着表中一行行的数据，数据库实例的作用之一就是读取页中存放的行记录。InnoDB 存储引擎提供了 Compact和 Redundant两种格式来存放行记录数据。       

**compact 行记录的设计目标是高效的存储数据（一个页中存储的行数据越多，其性能就越高），格式如下：**          
![存储概览](/img/mysql/compact.png)    
1. 变长字段长度列表，其按照列的顺序逆序放置：变长字段长度最大不超过2字节（MySQL数据库varcahr类型的最大长度限制为65535）   
2. NULL标识位：该标识的每一位指示了该行数据中对应字段是否为NULL值，有则用1。    
3. 记录头信息：固定占用5字节（40位）   
![存储概览](/img/mysql/header.png)    
4. 列N数据：实际存储每列的数据，NULL不占该部分任何空间，即NULL占有NULL标志位，实际存储不占任何空间。      

> 注： 
1. 每一行数据除了用户定义的例外，还有两个隐藏列，事物ID列和回滚指针列，分别为6字节和7字节的大小，若InnoDB表没有定义主键，每行还未增加一个6字节的rowid列。   
2. innodb 存储引擎在页内部是通过一种链表的结构来串联各个行记录的
3. varchar 类型的最大长度为65532   

**行溢出数据**     
InnoDB 存储引擎可以将一条记录中的某些数据存储在真正的数据页面之外。
**InnoDb存储引擎表是索引组织的，即B+树结构，这样每个页中至少应该有两条行记录。因此，如果页中只能存放下一条记录，那么InnoDB存储引擎会自动将行数据存放在溢出页中**
![存储概览](/img/mysql/cache.png)    

#### 约束
关系数据库本身能保证存储数据的完整性，不需要应用程序的控制。关系型数据库通过约束机制提供了一条强大而简易的途径来保证数据库中数据的完整性。
* 实体完整性保证表中有一个主键。在InnoDB存储引擎表中，用户可以通过定义primary key或unique key约束来保证实体的完整性
* 域完整性保证数据每列的值满足特定的条件
* 参照完成性保证两张表之间的关系。用户定义外键以强制参照完整性 

#### 分区
分区的过程是将一个表或索引分解为多个更小、更可管理的部分。MySQL数据库的分区是局部分区索引，一个分区中既存放了数据还存放了索引

---

## 问题：

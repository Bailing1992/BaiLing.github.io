---
layout: post
title: "Mysql 系列 事务"
subtitle: 'Mysql 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - mysql
---

## 概念

#### 事务
事务会把数据库从一种一致状态转换到另一种一致 状态。

事务是访问并更新数据库中各种数据项的一个程序执行单元。在事务中的操作，要么都做修改，要么都不做，这就是事务的目的。
#### ACID特性
InnoDB存储引擎中的事务完全符合ACID特性。

* 原子性： 整个数据库事务是不可分割的工作单位。
* 一致性： 事务将数据库从一种状态转换为下一种一致的状态。
* 隔离性： 要求每个读写事务的对象对其他事务的操作对象能相互隔离，即该务提交前对其他事务不可见。
* 持久性： 事务一旦提交，其结果就是永久性的。**持久性保证事务系统的高可靠性， 而不是高可用性**

对于Innodb存储引擎来说，其默认的事务隔离级别是read repeatable,完全遵循和满足事务ACID特性。

#### 事务类型
InnoDB 支持扁平事务、带有保存点的事务、链事务和分布式事务

* 扁平事务：所有操作处于同一层次，其由 begin work开始，由 commit work或 rollback work结束，其间的操作是原子的。
扁平事务是应用程序称为原子操作的基本组成模块。
* 带有保存点的扁平事务：允许在事务执行过程中，回滚到同一事务中较早的一个状态。**保存点用来通知系统应该记住事务当前的状态，以便当之后发生错误时，事务能够回到保存点当时的状态**
* 链事务：在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式的传给下一个要开始的事务。**提交事务操作和开始下一个事务操纵将合并为一个原子操作**
* 嵌套事务：由一个顶层事务控制着各个层次的事务

* 分布式事务：通常是一个在分布式环境下运行的扁平事务，因此需要根据数据所在的位置访问网络中不同的节点。

#### 事务实现
> 隔离性：锁来实现
> 原子型、持久性、一致性： 通过数据库的redo log（重做日志，保证事务原子型和持久性） 和 undo log（保证事务的一致性）进行实现

宏观上，InnoDB 通过 Force Log at Commit机制实现事务的持久性，即当事务提交时，必须先将该事务的所有重做日志写入到重做日志文件进行持久化，待事务的commit操作完成才算完成。重做日志包括redo log 和undo log， redo log 保证事务的持久性，undo log用来帮助事务回滚及MVCC的功能。   
*redo 和 undo的作用都可以视为一种恢复操作，redo恢复提交事务修改的页操作，而undo回滚行记录到某个特定版本*
> redo log 基本上都顺序写的，在数据库运行期间不需要对redo log 文件进行读取操作。
> undo log 是需要进行随机读写的。
#### redo
重做日志实现事务的持久性。其由两部分组成： 
* 一是内存中的重做日志缓冲区，其是易失的
* 二是重做日志文件，其是持久的
重做日志是物理日志，记录的是页的物理修改操作.    
重做日志是以512字节存储的，即重做日志缓存、重做日志文件都是以块的方式进行的，称之为重做日志块，每块的大小为512字节.    
**由于重做日志块的大小和磁盘扇区的大小一样，都是512字节，因此重做日志块的写入可以保证原子型，不需要doubleWrite技术**
##### 重做日志刷盘策略:
0. 事务提交时不进行写入重做日志文件操作，这个操作仅在master thread 中完成，在master thread中每一秒会进行一次重做日志的fsync操作。
1. 事务提交时必须调用一次fsync操作
2. 表示事务提交时将重做日志写入重做日志文件，但仅仅写入文件系统的缓存中，不进行fsync操作。
##### LSN
日志序列号（log sequence number），占用8字节，并且单调递增
LSN 表示的含义有：
* 重做日志写入的总量
* checkpoint的位置
* 页的版本
#### undo log
undo 存放在数据库内部的一个特殊段中，这个段称为undo段，位于共享表空间中。
undo 是逻辑日志，因此只是将数据库逻辑的恢复到原来的。所有修改都被逻辑地取消了，但是数据结构和页本身在回滚之后可能大不相同。    
当InnoDB 存储引擎回滚时，它实际上做的是与先前相反的操作。

undo的另一个作用是MVCC，即在InnoDB 存储引擎中MVCC的实现是通过undo来完成。当用户读取一行记录时，若该记录已经被其他事务占用，当前事务可以通过undo读取之前的行版本信息，以此实现非锁定读取。

undo log会产生redo log
#### binlog 二进制日志
用来进行point-in-time的恢复及主从复制环境的建立。
##### 重做日志和二进制日志的区别:
  * 重做日志在InnoDB存储引擎层产生。
    * 重做日志是物理格式日志，其记录的是对于每个页的修改。
    * 在事务的进行中不断地被写入
  * 二进制日志在mysql数据库的上层产生，mysql数据库中的任何存储引擎对于数据库的更改都会产生二进制文件。
    * 二进制日志是一种逻辑日志，其记录的是对应的sql语句.
    * 二进制日志只在事务提交完后一次性写入


#### pluge 操作
用于最终完成delete和update操作，这样设计是因为innodb存储引擎支持MVCC，所以记录不能在事务提交时立即进行处理。    


#### group commit
一次fsync可以刷新确保多个事务日志被写入文件。

#### MySQL 5.6 BLGC 事务提交过程
在MySQL数据中上层进行事务提交时，首先按顺序将其放入一个队列中，队列中的第一个事务称为leader,其他事务称为follower，leader 控制着follower的行为
Binary Log Group Commit 的实现方式是将事务提交的过程分为几个步骤：
* FLUSH阶段：将每个事务的二进制日志写入内存中
* SYNC阶段：将内存中的二进制日志刷到磁盘中，若队列中有多个事务，那么仅一次fsync操作就完成了二进制日志的写入，这就是BLCC
* COMMIT阶段：leader按照顺序调用存储引擎层事务的提交，

#### 事务控制语句
事务是自动提交的，

#### 隔离级别
###### 读未提交 read uncommitted
浏览访问
###### 读未提交 read committed
除了唯一性的约束检测及外键约束的检测需要gap lock，InnoDB存储引擎不会使用gap Lock的锁算法。

###### 默认可重复度 repeatable read
InnoDB 使用Next-key Lock锁的算法，避免了幻读的问题。即InnoDB在可重复读事务隔离级别下已经完全保证事务隔离性的要求，即达到SQL标准的SERIALIZABLE隔离级别。

###### SERIALIABLE
SERIALIABLE的事务隔离级别主要用于InnoDB存储引擎的分布式事务。

#### 分布式事务
通过XA事务来支持分布式事务的实现。
分布式事务是指允许多个独立的事务资源参与到一个全局的事务中。事务资源通常是指关系型数据库系统，但也可以是其他类型的资源。
在使用分布式事务时，InnoDB 存储引擎的事务隔离级别必须设定为SERIALIZABLE。

#### 不好的事务习惯

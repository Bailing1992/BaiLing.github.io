---
layout: post
title: "Mysql 系列 第三讲"
subtitle: 'Mysql 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - mysql
---

> 主要介绍《Mysql 技术内幕：InnoDB存储引擎》第四章有关表相关知识点。
* 表的逻辑存储及实现
* 表的物理存储特征，即数据在表中是如何组织和存放的

## 概念：
#### 表
关于特定实体的数据集合
#### 索引组织表
表根据主键顺序组织存放，每张表都有一个主键     
**主键的选择或创建**      
* 选表中非空的唯一索引
* 创建一个6字节大小的指针    
#### 逻辑存储结构：   
所有数据都被逻辑的存放在一个空间中，称为表空间。表空间由段、区、页组成。    

**表空间**    
逻辑结构的最高层，所有数据存放在表空间中。    
* 共享表空间 
* 独立表空间：    

**只存放数据、索引和插入缓存bitmap页。其他的数据，如回滚信息、插入缓存索引页、系统事务信息、二次写缓存等还是存放在共享表空间中**

**段**       
表空间由各个段组成：
* 数据段：即B+ 树的叶子节点
* 索引段：即B+ 树的非索引节点
* 回滚段

**区**    
由连续页组成的空间，在任何情况下每个区的大小都是1MB。    
*在默认情况下，innodb存储引擎页的大小为16kB，即一个区中一共有64个连续的页*    
在用户启动了参数innodb_file_per_table，每个段开始时，先用32个页大小的碎片页来存放数据，在使用完这些页之后才64个连续页的申请。    

**页**    
页是innodbci磁盘管理的最下单位   

**行**    
每个页允存放的行记录有硬性规定，最多允许存放16KB/2-200 = 7992行的记录。     
#### 行记录的格式    
记录以行的形式存储。    
**Antelope 文件格式下用于两种行记录格式**       
* compact行格式        
行记录格式如下：          
![存储概览](/img/mysql/compact.png)    
1. 变长字段长度列表，其按照列的顺序逆序放置：变长字段长度最大不超过2字节（MySQL数据库varcahr类型的最大长度限制为65535）   
2. NULL标识位：该标识的每一位指示了该行数据中对应字段是否为NULL值，有则用1。    
3. 记录头信息：固定占用5字节（40位）   
![存储概览](/img/mysql/header.png)    
4. 列N数据：实际存储每列的数据，NULL不占该部分任何空间，即NULL占有NULL标志位，实际存储不占任何空间。      

注： 
1. 每一行数据除了用户定义的例外，还有两个隐藏列，事物ID列和回滚指针列，分别为6字节和7字节的大小，若InnoDB表没有定义主键，每行还未增加一个6字节的rowid列。   
2. innodb 存储引擎在页内部是通过一种链表的结构来串联各个行记录的
3. varchar 类型的最大长度为65532

**redundant行格式**

**Barracuda文件格式下用于两种新的行记录格式：**     
* compressed行记录格式
* dynamic行记录格式
新的两种记录格式对于存放在BLOB中的数据采用了完全的行溢出的方式。
![存储概览](/img/mysql/barracuda.png)    

#### 行溢出数据    
**InnoDb存储引擎是索引组织的，即B+ 树结构，这样每个页中至少应该有两条行记录。因此，如果页中只能存放下一条记录，那么innodb存储引擎会自动将行数据存放在溢出页中**
![存储概览](/img/mysql/cache.png)    




---

## 问题：

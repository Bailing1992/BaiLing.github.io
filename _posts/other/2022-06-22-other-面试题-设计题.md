---
layout: post
title: "面试题-设计题汇总"
author: "lichao"
header-img: "img/post/bg/host.png"
catalog: true
tags:
  - other
---

## 请谈谈限流器的设计
互联网秒杀场景下，很多接口的峰值流量非常非常陡峭，必须做好限流不然会把内部系统打挂。请设计一个分布式限流器，能实现这个功能。 
1. 限流器能work，精确度达到 99% 以上 
2. 限流阈值大小可设置，大的达到1000w级QPS，小的小到10QPS级别 
3. 通用的限流器，不局限于某一业务领域

**答案：**        
1. 利用redis的原子自增和过期淘汰策略
  - 限流器的计数存放在redis中，用redis的过期淘汰策略实现限流器的计数的定期更新 
  - 例如针对 接口A 限流 10000 QPS。redis的key为：“接口A”，value为计数值 
  - 每次接口调用Redis用INC原子自增命令，自增1，并设置过期时间为1s 
  - 初次调用时，因为redis中该key没有，就直接设置为1，并设置过期时间为1s
  - 在这一秒以内的后续调用，每次都自增1 - 客户端拿到自增后的值如果没有超过限制10000，就放行 - 如果超过 10000 限制，就不放行，说明超限了
  - 细节实现：为避免超限后无谓的redis调用，第一次发现超限时可以记录该值的TTL时间，例如只过去100ms就有1w个请求过来，剩下的900ms就不用请求redis而是直接返回超限即可。不然这种情况会给redis带去额外无谓的流量，例如前面的例子，不做这个细节逻辑的话，redis的请求量是 10w QPS。
  - 精度可调节。假如限流阈值很大，比如100w，可以把INC自增步进/步长调整大一些，例如100，那么redis的QPS直接降低100倍，为1w QPS。

**扩展：**          
此题目给的解法相当于限流器中的固定窗口，固定窗口应对流量尖刺不理想，可以引申一步讨论 [滑动窗口、令牌桶、漏桶 的实现](https://zhuanlan.zhihu.com/p/51681984)，另外有一个现成的[redis module使用漏桶实现了限流器](https://github.com/brandur/redis-cell)


## 请设计短网址系统
1. 分为两个接口 
	- 从一个长网址生成一个短网址。需要考虑：同一个长网址，多次创建的短网址是否相同 
	- 用户访问短网址时，需要能跳回到原始的长网址 
2. 需要考虑跨机房部署问题 
3. 加分项：考虑跨海域全球部署问题 
4. 加分项：考虑统计某个域名下的URL/host访问uv和pv


**答案：**        
1. 一开始需要能考虑系统承载容量，例如： 
  - 每天100亿访问量
  - 每天生成1000w条短网址记录 
2. 然后考虑短网址的生成算法，方案有很多种 
  - 最简单实现：自增id实现，这个不可逆，同一个长网址会生成多个短网址 
  - hash+序号冲突 
  - 使用kv存储双向对应关系，可逆，但存储用量比较大 
3. 302跳转问题，附带可以讨论网址访问量计数问题 
4. 加分项1：需要考虑跨机房部署问题 
5. 加分项2：考虑跨海域全球部署问题 
6. 加分项3：能给出合理的统计需求，例如用hadoop做MR


## 计数系统设计
头条里有各种计数需求，我们希望能够有一个统一的计数服务来满足该需求，主要功能要求根据业务需求查询指定的文章的计数统计（播放数，阅读数，评论数等），要求：支持实时更新各种计数，支持高并发查询，需要给出系统存储设计方案，对外输出接口设计；

**答案:**    
+ 方案一：直接使用数据库+cache的方案，方案简单有效，数据量大之后采用分库方案，扩展性有限，但开发和运维成本低，性能方面通过cache优化，存在热点数据（可能导致cache经常被清理）；
+ 方案二：采用redis作为kv存储，查询效率足够高，但需要考虑资源使用问题，假设有10亿的文章，帖子和评论，如何保证以更低的成本满足该需求；主要问题需要较多资源，成本较高，如何设计更好数据结构；（3+）
+ 方案三：可以自己开发counter模块，需要考虑kv存储方案，value的设计，保证使用更少内存；还需要考虑的点：容灾备份机制；数据扩展问题；（3.5）
+ 方案四：可能业务方经常新增计数需求，需要考虑counter服务的列扩展性，故设计的数据结构需要考虑列扩展问题；（3.5）
+ 其他：业务写入QPS可能比较高，考虑写入压力问题，数据写入去重问题，即同一个用户转发之类操作需要幂等性（一定程度保证即可）
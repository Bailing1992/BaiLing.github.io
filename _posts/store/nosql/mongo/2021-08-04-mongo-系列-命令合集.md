---
layout: post
title: "Mongo 命令合集"
subtitle: '开启 MongoDB 学习新篇章'
author: "lichao"
header-img: "img/post-bg-rwd.jpg"
catalog: true
tags:
  - Mongo 
---

## 数据类型
* null 表示空值或者不存在的字段。
* 布尔型有两个值 true或false
* 数值，默认使用64位浮点型数值，整型数使用NumberInt类（表示4字节带符号整数）或NumberLong类（表示8字节带符号整数）表示。
* 字符串，表示 UTF-8 字符串
* 日期，表示自新纪元以来的毫秒数


## 示例：
为便于下面的代码演示，设想一个存储博客数据的应用场景，在集合中存储博客信息，其中包括博客名字、内容、作者、点赞数、评论列表：
```json
{
  "title": "blog title",
  "author": "chao",
  "votes": 0,
  "content": ["blog content one", "blog content one"]
}
```

## 命令
* 查看当前指向的数据库 
```javascript
> db
```

* 选择数据库 
```javascript
> use foobar 
```

#### 插入数据
``` 
> db.blog.insert(post) 
> db.blog.batchInsert(post1, post2...) 
```
所有文档都必须小于16MB。

在一个集合里面，每个文档都有唯一的```_id```， 这个键的值可以是任意类型的，默认是个 ObjectId 对象。ObjectId使用12字节的存储空间，是一个由24个十六进制数字组成的字符串。
![objectId结构](/img/mongodb/objectId.png)


* 查找数据
``` > db.blog.find() ```

* 查找一个数据
``` > db.blog.findOne() ```

#### 更新数据







* update 方法有两个参数，一个是查询文档，用于定位需要更新的目标文档，另一个是修改器文档，用于说明要对找到的文档进行哪些修改。
``` 
> db.blog.update({"title":"My Blog Post"}, {"title":"Your Blog Post"}) 
```

> 通常文档只有一部分要更新，可以使用原子性的更新修改器，指定对文档中的某些字段进行更新。更新修改器是种特殊的键，用来指定复杂的更新操作，比如修改、增加或者删除键，还可能操作数组或者内嵌文档。

* ```$inc``` 修改器为指定 key 原子性的增加值，只能用于整型、长整形或双精度浮点型的值，用于其他类型会导致操作失败。
```
> db.analytics.update({"url":"www.example.com"}, {"$inc":{"pageviews":1}})
```
使用修改器时，```_id```的值不能改变，整个文档替换时，可以改变```_id```。其他的键，包括唯一索引的键，都是可以改变的。

* ```$set``` 修改器用来指定一个字段的值，可用于更新或增加用户定义的键。甚至可以修改键的类型。
```
db.users.update({"_id": ObjectId("...")}, {"$set":{"favirote book":"War and Peace"}})
```

* ```$unset``` 修改器用于删除键
```
db.users.update({"name": "joe"}, {"$unset":{"favirote book": 1}})
```

* ```$push``` 修改器用于向已有的数组末尾加入一个元素，没有则创建一个新的数组。
```
db.blog.posts.update({"title":"a blog psot"}, {"$push":{"comments":{"name":"joe", "content":"nice post"}}})
```
* ```$push``` 修改器与```$each```子操作符结合，添加多个值。
```
db.stock.ticker.update({"_id":"..."}, {"$push": {"hourly":{"$each":[2.1,1.2]}}})
```
* ```$push``` 修改器与```$each、$slice```子操作符结合，可保证数组不会超出设定的最大长度。```$slice```的值必须是负数，保留最后的 n 个。
```
db.movies.find({"genre":"..."}, {"$push": { "tpo10": {
  "$each": ["Nccc", "sss"],
  "$slice": -10}}})
```
* ```$push``` 修改器与```$each、$slice、$sort```子操作符结合，可保证数组不会超出设定的最大长度。保留排序之后的 n 个。
```
db.movies.find({"genre":"..."}, {"$push": { "tpo10": {
  "$each": ["Nccc", "sss"],
  "$slice": -10
  "$sort":{"rating":-1}}}})
```
* ```$push``` 修改器与 ```$ne```操作符结合，保证数组内元素不重复
```
db.papers.update({"authors cited":{"$ne":"R"}}, {"$push":{"authors cited":"R"}})
```
* ```$push``` 修改器与 ```$addToSet```操作符结合，避免重复插入
```
db.papers.update({"_id":"xx"}, {"$addToSet":{"authors cited":"R"}})
```
* ```$push``` 修改器与 ```$addToSet、$each```操作符结合，插入多个值，同时避免重复插入
```
db.papers.update({"_id":"xx"}, {"$addToSet":{"authors cited":{"$each":["AA","BB"]}}})
```

* 通过位置或定位操作符("$")操作数组中的值。数组下表以0开始，可以将下标直接作为键来选择元素，例如增加第一个评论的：

```
> db.blog.insert({"post":NumberLong(1),"comments":[{"comment":"good post","author":"John","votes":NumberLong(0)},{"comment":"bad post","author":"jim","votes":NumberLong(3)}]})

> db.blog.update({"post":1}, {"$inc": {"comments.0.votes": 1}}) 
```
* 可使用 定位操作符"$"来定位查询文档已经匹配的数据元素，并进行更新。定位符只能更新第一个匹配的元素。
```
> db.blog.update({"comments.author":"John"}, {"$set": {"comments.$.author": "Jim"}}) 
```

> 数组修改器可能会改变文档的大小，会造成插入性能下降。

> 将文档插入到MongoDB时，依次插入的文档在磁盘上的位置是相邻的，如果中间的一个文档变大了，原先的位置就放不下了，这个文档就会被移动到集合中的另一个位置。
> 当MongoDB不得不移动一个文档时，它会修改集合的填充因子，填充因子是MongoDB为每个新文档预留的增长空间。可以查看```db.coll.stats()```查看填充因子。

> 如果业务在进行插入和删除时会进行大量的移动或经常打乱数据，可以使用 usePowerOfSizes 选项以提高磁盘复用率，这个集合之后进行的所有空间分配，得到的块大小都是 2 的幂。由于这个选项会导致初始空间分配不再那么高效，所以应该只有需要经常打乱数据的集合上使用。在一个只进行插入和原地更新的集合上使用这个选项，会导致写入速度变慢。


* upsert 更新在没有找到符合更新条件的文档时，会以这个条件和更新文档为基础创建一个新的文档，如果找到了匹配的文档，则正常更新。而且 upsert 是原子性的、能够避免竞态（重复插入）问题。udpate 的第三个参数表示这是一个 upsert:
```
> db.blog.update({"comments.author":"John"}, {"$inc": {"comments.$.votes": 1}}, true) 
```

* ```$setOnInsert```在创建文档的同时创建字段并为它赋值，在之后的所有的更新操作中，这个字段的值都不在改变。即```$setOnInsert```只会在文档插入时设置的字段的值。
```
> db.blog.update({"comments.author":"John"}, {"$inc": {"comments.$.votes": 1}}, true) 
```

* 更新多个文档。默认情况下，更新只能对符合条件的第一个文档执行操作。如果需要更新所有匹配的文档，可以将update的第四个参数设置为 true。下面是给指定生日的所有用户添加了 gift 键。
```
> db.users.update({"birthday":"10/13/1978"}, {"$set": {"gift": "happy Bitchday"}}, false, true) 
```
#### 删除数据
数据删除是永久性的，不能撤销，也不能恢复。
``` > db.blog.remove({"title":"My Blog Post"}) ```

若把数组看成队列或者栈，可以用 ```$pop```修改器从数组任何一端删除元素，```{ "$pop":{"key":1}```从数组末尾删除一个元素，```{ "$pop":{"key":-1}```则从头部删除元素。

```
> db.lists.insert({"todo":["dists", "laundry", "dry cleaning"]})
> db.lists.update({"$pop": {"todo": 1}}) 
> db.lists.update({"$pop": {"todo": -1}}) 
```
可以用 ```$pull```修改器删除匹配的所有元素。

```
> db.lists.insert({"todo":["dists", "laundry", "dry cleaning"]})
> db.lists.update({"$pull": {"todo": "laundry"}}) 
```

#### 删除集合
``` > db.blog.drop() ```
不能指定任何限定条件。


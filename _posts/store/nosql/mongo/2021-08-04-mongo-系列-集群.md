---
layout: post
title: "Mongo 集群"
subtitle: '开启 MongoDB 学习新篇章'
author: "lichao"
header-img: "img/post-bg-rwd.jpg"
catalog: true
tags:
  - Mongo 
---

> 索引可以用来优化查询，为集合选择合适的索引是提升性能的关键。

#### 查询
可以使用 ```expalin()``` 函数查看在执行查询的过程中所做的事情。

```javascript
> db.blog.find({"title":"my blog title"}).explain("executionStats")

```

explain()可以设置参数：
* queryPlanner
* executionStats
* allPlansExecution

结果
```json
{
	"queryPlanner" : {
		"plannerVersion" : 1,
		"namespace" : "test.blog",
		"indexFilterSet" : false,
		"parsedQuery" : {
			"title" : {
				"$eq" : "my blog title"
			}
		},
		"winningPlan" : {
			"stage" : "COLLSCAN",
			"filter" : {
				"title" : {
					"$eq" : "my blog title"
				}
			},
			"direction" : "forward"
		},
		"rejectedPlans" : [ ]
	},
	"executionStats" : {
		"executionSuccess" : true,
		"nReturned" : 1,
		"executionTimeMillis" : 1,
		"totalKeysExamined" : 0,
		"totalDocsExamined" : 7,
		"executionStages" : {
			"stage" : "COLLSCAN",
			"filter" : {
				"title" : {
					"$eq" : "my blog title"
				}
			},
			"nReturned" : 1,
			"executionTimeMillisEstimate" : 0,
			"works" : 9,
			"advanced" : 1,
			"needTime" : 7,
			"needYield" : 0,
			"saveState" : 0,
			"restoreState" : 0,
			"isEOF" : 1,
			"direction" : "forward",
			"docsExamined" : 7
		}
	},
	"serverInfo" : {
		"host" : "C02CPDBCMD6M",
		"port" : 27017,
		"version" : "4.4.6",
		"gitVersion" : "72e66213c2c3eab37d9358d5e78ad7f5c1d0d0d7"
	},
	"ok" : 1
}
```

为了优化查询，可将查询结果限制为 1，这样 MongoDB 在找到一个文档之后就会停止了。

```javascript
> db.blog.find({"title":"my blog title"}).limit(1).explain("executionStats")

```

字段 nReturned 显示查询结果的数量。
字段 totalDocsExamined 表示检索的文档数量。
字段 totalKeysExamined 表示检索的索引数量。

#### 索引
> 索引可以根据给定的字段组织数据, 让 MongoDB 能够非常快地找到目标数据。

对于添加的每一个索引，每次写操作（插入、更新、删除）都将耗费更多的时间，因为当数据发生变动时，MongoDB不仅要更新文档，还要更新集合上的所有索引。

MongoDB 限制每个集合上最多只能有 64 个索引。
###### 创建索引

```javascript
> db.blog.ensureIndex({"title": 1})


{
	"createdCollectionAutomatically" : false,
	"numIndexesBefore" : 1,
	"numIndexesAfter" : 2,
	"ok" : 1
}
```

建立复合索引(建立在多个字段上的索引)
```javascript
> db.blog.ensureIndex({"title": 1, "votes": 1})

```

使用索引键对文档进行排序非常高效

```javascript
> db.blog.find().sort({"title": 1, "votes": 1})

```

MongoDB 可以在任意方向上对索引进行遍历

```javascript
> db.blog.find({"title": "my blog title"}).sort({"votes": -1})
```

这是一个点查询，用于查找单个值（尽管这个值的文档可能有多个），由于索引中的第二个字段，查询结果已经是有序的了，MongoDB可以从匹配的最后一个索引开始，逆序依次遍历索引。


```javascript
> db.blog.find({"title": {"$gt": "my", "$lte": "my blog title"}})
```
这是一个多值查询，利用索引的第一个键查找到多个值相匹配的文档。通常来说，如果 MongoDB 使用索引进行查询，那么查询结果文档通常是按照索引顺序排列的。

```javascript
> db.blog.find({"title": {"$gt": "my", "$lte": "my blog title"}}).sort({"votes": -1})
```

使用索引得到的结果集中 ```votes```是无序的，所以MongoDB需要现在

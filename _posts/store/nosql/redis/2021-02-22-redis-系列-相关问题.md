---
layout: post
title: "Redis 系列 相关问题"
subtitle: '开启 redis 探索新篇章'
author: "lichao"
header-img: "img/post-bg-rwd.jpg"
catalog: true
tags:
  - redis 
---

## Redis 有哪些数据结构？
Redis 有 5 种基础数据结构，字符串 String、字典 Hash、列表 List、集合 Set、有序集合 Zset。

[详情请-数据结构](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)

## Redis 的常见使用场景？
#### 缓存
Redis 最常见的用途就是拿来做缓存了，一般和 MySQL 结合使用。当请求到达时，先访问 Redis 尝试取数据，若 Redis 里面没有则从 MySQL 中读取，拿到数据以后写缓存，返回。由于 Redis 访问速度快、支持的数据类型比较丰富，所以 Redis 很适合用来存储热点数据，另外结合 EXPIRE，我们可以设置过期时间然后再进行缓存更新操作，这个功能最为常见，我们几乎所有的项目都有所运用。

Redis 用做缓存时一般只用到 string 类型，具体来讲就是把对象序列化以后保存，而不是用 hash 保存对象的每一个字段

[关联文章-Redis 缓存和 MySQL 数据一致性方案](https://bailing1992.github.io/2020/05/29/redis-%E7%B3%BB%E5%88%97-Redis%E7%BC%93%E5%AD%98%E5%92%8CMysql%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88/)
#### 计数
Redis 由于 INCR 命令可以实现原子性的递增，所以可以运用于高并发的秒杀活动、分布式序列号的生成、具体业务还体现在比如限制一个手机号发多少条短信、一个接口一分钟限制多少请求、一个接口一天限制调用多少次等等。
#### 排序
利用 Redis 的列表和有序集合的特点，可以制作排行榜系统，而排行榜系统目前在商城类、新闻类、博客类等等，都是比不可缺的。比如一个博主的所有文章按照发布时间排序等。在抖音中比如商业化挑战里面的视频排序等。
#### 存储
特点是最终一致性、可能会丢数据。
#### 分布式锁
在很多互联网公司中都使用了分布式技术，分布式技术带来的技术挑战是对同一个资源的并发访问，如全局ID、减库存、秒杀等场景，并发量不大的场景可以使用数据库的悲观锁、乐观锁来实现，但在并发量高的场合中，利用数据库锁来控制资源的并发访问是不太理想的，大大影响了数据库的性能。可以利用Redis的setnx功能来编写分布式的锁，如果设置返回1说明获取锁成功，否则获取锁失败，实际应用中要考虑的细节要更多。

[关联文章-分布式锁](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/)
## 假如 Redis 里面有 1 亿个 key，其中有 10w 个 key 是以某个固定的已知的前缀开头的，如果将它们全部找出来？
使用 keys 指令可以扫出指定模式的 key 列表。

Redis 的单线程的。

keys 指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用 scan 指令，scan 指令可以无阻塞的提取出指定模式的 key 列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用 keys 指令长。

## 使用过 Redis 做异步队列么，怎么用的？
一般使用 ```list``` 结构作为队列，```rpush``` 生产消息，```lpop``` 消费消息。当 ```lpop``` 没有消息的时候，要适当 ```sleep``` 一会再重试。

如果不想重试，```list``` 还有个指令叫 ```blpop```，在没有消息的时候，它会阻塞住直到消息到来。

#### 如果有大量的 key 需要设置同一时间过期，一般需要注意什么？

如果大量的 key 过期时间设置的过于集中，到过期的那个时间点，Redis 可能会出现短暂的卡顿现象。一般需要在时间上加一个随机值，使得过期时间分散一些。

## Redis 集群的原理是什么？
Redis Sentinal 着眼于高可用，在 master 宕机时会自动将 slave 提升为 master，继续提供服务。

Redis Cluster 着眼于扩展性，在单个 redis 内存不足时，使用 Cluster 进行分片存储
## Redis 如何做持久化的？

bgsave 做镜像全量持久化，aof做增量持久化。因为bgsave会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要aof来配合使用。在redis实例重启时，会使用bgsave持久化文件重新构建内存，再使用aof重放近期的操作指令来实现完整恢复重启之前的状态。

#### 如果突然机器掉电会怎样？

取决于 aof 日志 sync 属性的配置，如果不要求性能，在每条写指令时都 sync 一下磁盘，就不会丢失数据。但是在高性能的要求下每次都 sync 是不现实的，一般都使用定时sync，比如 1s1 次，这个时候最多就会丢失 1s 的数据。

#### bgsave 的原理是什么？

fork 和 cow。fork 是指 redis 通过创建子进程来进行 bgsave 操作，cow 指的是copy on write，子进程创建后，父子进程共享数据段，父进程继续提供读写服务，写脏的页面数据会逐渐和子进程分离开来。


## Pipeline 有什么好处，为什么要用 pipeline？

可以将多次 IO 往返的时间缩减为一次，前提是 pipeline 执行的指令之间没有因果相关性。使用 redis-benchmark 进行压测的时候可以发现影响 redis 的 QPS 峰值的一个重要因素是 pipeline 批次指令的数目。

## Redis 的同步机制了解么？

Redis 可以使用主从同步，从从同步。第一次同步时，主节点做一次bgsave，并同时将后续修改操作记录到内存buffer，待完成后将rdb文件全量同步到复制节点，复制节点接受完成后将rdb镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。


---
layout: post
title: "redis 系列 数据结构"
subtitle: '总结redis中涉及的数据结构'
author: "lichao"
header-img: "img/post-bg-rwd.jpg"
catalog: true
tags:
  - redis 
---

> Redis 有 5 种基础数据结构，分别为 string字符串，list列表，set集合，hash哈希，zset有序集合。

## string字符串
键值对的键是一个字符串对象，值可能是一个字符串对象。

> Redis 所有的数据结构都是以唯一的 key 字符串作为名称，然后通过这个唯一 key 值来获取相应的 value 数据。不同类型的数据结构的差异就在于 value 的结构不一样。

![存储概览](/img/redis/1.png)

Redis 字符串是动态字符串，是可以修改的字符串，内部结构实现上类似于 Java 的 ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配，如图中所示，内部为当前字符串实际分配的空间 capacity 一般要高于实际字符串长度 len。当字符串长度小于 1M 时，扩容都是加倍现有的空间，如果超过 1M，扩容时一次只会多扩 1M 的空间。需要注意的是字符串最大长度为 512 M。

## list列表
![存储概览](/img/redis/2.png)

列表底层存储是称之为快速链表 quicklist 的一个结构。

首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是 ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。当数据量比较多的时候才会改成 quicklist。Redis 将链表和 ziplist 结合起来组成了 quicklist。也就是将多个 ziplist 使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。

#### 使用场景
Redis 的列表结构常用来做异步队列使用。将需要延后处理的任务结构体序列化成字符串塞进 Redis 的列表，另一个线程从这个列表中轮询数据进行处理。

## hash字典
Redis 字典相当于 Java 语言里面的 HashMap，它是无序字典。内部实现结构上同 Java 的 HashMap 也是一致的，同样的数组 + 链表二维结构。第一维 hash 的数组位置碰撞时，就会将碰撞的元素使用链表串接起来。
![存储概览](/img/redis/4.png)
不同的是，Redis 的字典的值只能是字符串，另外它们 rehash 的方式不一样，因为 Java 的 HashMap 在字典很大时，rehash 是个耗时的操作，需要一次性全部 rehash。Redis 为了高性能，不能堵塞服务，所以采用了渐进式 rehash 策略。
![存储概览](/img/redis/3.png)

渐进式 rehash 会在 rehash 的同时，保留新旧两个 hash 结构，查询时会同时查询两个 hash 结构，然后在后续的定时任务中以及 hash 的子指令中，循序渐进地将旧 hash 的内容一点点迁移到新的 hash 结构中。

## set集合
Redis的集合相当于Java语言里面的HashSet，它内部的键值对是无序的唯一的。它的内部实现相当于一个特殊的字典，字典中所有的value都是一个值NULL。

## zset有序集合

Redis的zset是一个复合数据结构，一方面它需要一个hash结构来存储value和score的对应关系，另一方面需要提供按照score来排序以便能够指定score的范围来获取value列表，这就需要另外一个结构「跳跃列表」。

![存储概览](/img/redis/zset存储结构.png)

> zset 的内部实现是一个 hash 字典加一个跳跃列表 (skiplist)。

[详情请看zset有序集合](./2019-12-24-redis-系列-跳跃列表.md)

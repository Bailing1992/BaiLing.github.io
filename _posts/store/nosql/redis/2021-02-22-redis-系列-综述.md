---
layout: post
title: "Redis 系列 综述"
subtitle: '开启 redis 探索新篇章'
author: "lichao"
header-img: "img/post/bg/post-bg-rwd.jpg"
catalog: true
tags:
  - redis 
---

> Redis 将所有数据都放在内存，用一个单线程对外提供服务，单个节点在跑满一个 CPU 核心的情况下可以达到了 10w/s 的超高 QPS。

## Redis 有哪些数据结构？
Redis 有 5 种基础数据结构，字符串 String、字典 Hash、列表 List、集合 Set、有序集合 Zset。

[关联文档-数据结构](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)
## Redis 高效的原因？
* Redis 基于内存，内存的读写速度非常快
* Redis 单线程，省去了很多上下文切换线程的时间
* Redis 采用多路复用技术来处理并发的连接。内部实现采用非阻塞 IO(linux, epoll, 采用了 epoll+自己实现的简单的事件框架。将 epoll 中的读、写、关闭、连接都转化成了事件，然后利用 epoll 的多路复用特性，绝不在 io 上浪费一点时间)。

Redis 所有的数据都在内存中，所有的运算都是内存级别的运算。正因为 Redis 是单线程，所以要小心使用 Redis 指令，对于那些时间复杂度为 ```O(n)``` 级别的指令，一定要谨慎使用，一不小心就可能会导致 Redis 卡顿。

Redis 数据结构并不全是简单的 ```key-value```，还有 ```list\hash``` 等复杂的结构，这些结构有可能会进行很细粒度的操作，比如在很长的列表后面添加一个元素，在 hash 当中添加或者删除一个对象。这些操作可能就需要加非常多的锁，导致的结果是同步开销大大增加。总之，在单线程的情况下，就不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗。

[关联文档-线程模型](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/)
## Redis 存在那些问题?
* Redis 是基于内存的，内存是很昂贵的
* 不能保证数据持久化，虽然redis有存储方案，但是 aof 持久化也有很多问题。
* RedisCluster 的分布式方案，是基于 gossip 协议的，当数据量太大的时候，会有 gossip 风暴的问题。

## Redis 是强一致还是高可用的？
**Redis 主从数据是异步同步的，所以分布式的 Redis 系统并不满足「强一致性」要求。** 当客户端在 Redis 的主节点修改了数据后，立即返回，即使在主从网络断开的情况下，主节点依旧可以正常对外提供修改服务，所以 Redis 满足「高可用性」。

[关联文章-主从同步](https://bailing1992.github.io/2020/05/29/redis-%E7%B3%BB%E5%88%97-Redis%E7%BC%93%E5%AD%98%E5%92%8CMysql%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88/)

## Redis 的常见使用场景？
常见的使用场景是缓存、记数、分布式锁、排序和存储。下面逐一介绍。
#### 缓存
Redis 最常见的用途就是拿来做缓存了，一般和 MySQL 结合使用。当请求到达时，先访问 Redis 尝试取数据，若 Redis 里面没有则从 MySQL 中读取，拿到数据以后写缓存，返回。由于 Redis 访问速度快、支持的数据类型比较丰富，所以 Redis 很适合用来存储热点数据，另外结合 EXPIRE，我们可以设置过期时间然后再进行缓存更新操作，这个功能最为常见，我们几乎所有的项目都有所运用。

Redis 用做缓存时一般只用到 string 类型，具体来讲就是把对象序列化以后保存，而不是用 hash 保存对象的每一个字段

[关联文章-Redis 缓存和 MySQL 数据一致性方案](https://bailing1992.github.io/2020/05/29/redis-%E7%B3%BB%E5%88%97-Redis%E7%BC%93%E5%AD%98%E5%92%8CMysql%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88/)
#### 计数
Redis 由于 INCR 命令可以实现原子性的递增，所以可以运用于高并发的秒杀活动、分布式序列号的生成、具体业务还体现在比如限制一个手机号发多少条短信、一个接口一分钟限制多少请求、一个接口一天限制调用多少次等等。

#### 分布式锁
在很多互联网公司中都使用了分布式技术，分布式技术带来的技术挑战是对同一个资源的并发访问，如全局ID、减库存、秒杀等场景，并发量不大的场景可以使用数据库的悲观锁、乐观锁来实现，但在并发量高的场合中，利用数据库锁来控制资源的并发访问是不太理想的，大大影响了数据库的性能。可以利用Redis的setnx功能来编写分布式的锁，如果设置返回1说明获取锁成功，否则获取锁失败，实际应用中要考虑的细节要更多。

[关联文章-分布式锁](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/)

#### 排序
利用 Redis 的列表和有序集合的特点，可以制作排行榜系统，而排行榜系统目前在商城类、新闻类、博客类等等，都是比不可缺的。比如一个博主的所有文章按照发布时间排序等。在抖音中比如商业化挑战里面的视频排序等。
#### 存储
特点是最终一致性、可能会丢数据（业务对丢失少量数据不敏感）
* 线上存储型的 Redis 开启 aof 落盘
* 异步落盘

## 如果有大量的 key 需要设置同一时间过期，一般需要注意什么？

如果大量的 key 过期时间设置的过于集中，到过期的那个时间点，Redis 可能会出现短暂的卡顿现象。一般需要在时间上加一个随机值，使得过期时间分散一些。

[关联文章-过期清除](https://bailing1992.github.io/2020/05/29/redis-%E7%B3%BB%E5%88%97-%E8%BF%87%E6%9C%9F%E6%B8%85%E7%90%86/)

## Redis 集群的原理是什么？
Redis Cluster 着眼于扩展性，在单个 Redis 内存不足时，使用 Cluster 进行分片存储。

> 古老的 Redis Sentinal 方案着眼于高可用，在 master 宕机时会自动将 slave 提升为 master，继续提供服务。
> [关联文章-哨兵模式](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/)

[关联文章-集群](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E9%9B%86%E7%BE%A4/)

## Redis 同步机制是什么？
Redis 可以使用主从同步，从从同步。第一次同步时，主节点做一次 ```bgsave```，并同时将后续修改操作记录到内存buffer，待完成后将 rdb 文件全量同步到复制节点，复制节点接受完成后将 rdb 镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。

## 使用过 Redis 做异步队列么，怎么用的？
一般使用 ```list``` 结构作为队列，```rpush``` 生产消息，```lpop``` 消费消息。当 ```lpop``` 没有消息的时候，要适当 ```sleep``` 一会再重试。

如果不想重试，```list``` 还有个指令叫 ```blpop```，在没有消息的时候，它会阻塞住直到消息到来。

[关联文章-消息队列](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/)

#### 如果突然机器掉电会怎样？
 
取决于 aof 日志 ```sync``` 属性的配置，如果不要求性能，在每条写指令时都 ```sync``` 一下磁盘，就不会丢失数据。但是在高性能的要求下每次都 ```sync``` 是不现实的，一般都使用定时 ```sync```，比如 1s 1次，这个时候最多就会丢失 1s 的数据。

## pipeline 有什么好处，为什么要用 pipeline？

可以将多次 IO 往返的时间缩减为一次，前提是 pipeline 执行的指令之间没有因果相关性。使用 redis-benchmark 进行压测的时候可以发现影响 redis 的 QPS 峰值的一个重要因素是 pipeline 批次指令的数目。

## 假如 Redis 里面有 1 亿个 key，其中有 10w 个 key 是以某个固定的已知的前缀开头的，如果将它们全部找出来？
使用 keys 指令可以扫出指定模式的 key 列表。

Redis 的单线程的。

keys 指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用 scan 指令，scan 指令可以无阻塞的提取出指定模式的 key 列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用 keys 指令长。

[关联文章-游标查询](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E6%B8%B8%E6%A0%87%E6%9F%A5%E8%AF%A2/)


## Redis 支持事务吗？
Redis 事务使用非常简单，事务模型很不严格，不能像使用关系数据库事务一样来使用 Redis。


[关联文章-事务](https://bailing1992.github.io/2019/12/24/redis-%E7%B3%BB%E5%88%97-%E4%BA%8B%E5%8A%A1/)

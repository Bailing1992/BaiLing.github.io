---
layout: post
title: "存储 系列 分布式"
subtitle: '...'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - store
---

## 数据系统
数据系统是用于数据存储和处理的工具

## 系统软件核心设计目标
1. 可靠性（容错与高可用性）: 容忍硬件、软件失效和人为错误。即使发生了某些错误，系统仍可以继续正常工作。
2. 可扩展性：指负载增加时， 有效保持系统性能的相关技术策略。评测负载与性能、延迟百分位数、吞吐量
3. 可维护性： 可运维、简单和可演化性
   1. 可运维性: 方便运营团队来保持系统平稳运行
   2. 简单性: 简化系统复杂性，使新工程师能够轻松理解系统。
   3. 可演化性: 后续工程师能够轻松地对系统进行改进，井根据需求变化将其适配到非典型场景，也称为可延伸性、易修改性或可塑性。

> 系统可应对某些特定类型的错误则称为容错（Fault tolerant）或者弹性（Resilient）

> 故障通常被定义为组件偏离其正常规格，而失效意味系统作为一个整体停止，无法向用户提供所需的服务。我们不太可能将故障概率降低到零，因此通常设计容错机制来避免从故障引发系统失效

> 消除「复杂性」最好手段之一是抽象。一个好的设计抽象可以隐藏大量的实现细节，并对外提供干净、易懂的接口。一个好的设计抽象可用于各种不同的应用程序。
这样，复用远比多次重复实现更有效率；另一方面，也带来更高质量的软件，而质量过硬的「抽象组件」所带来的好处，可以使运行其上的所有应用轻松获益。

> 数据模型可能是开发软件最重要的部分，它们不仅对软件的编写方式，而且还对如何思考待解决的问题都有深远的影响。

## 可靠性
当单台机器（或者多台，以及网络甚至整个数据中心）出现故障，还希望应用系统可以继续工作，这时需要采用多台机器提供冗余。这样某些组件失效之后，冗余组件可以迅速接管。

#### 数据系统可靠方案-复制
复制主要指通过互联网络在多台机器上保存相同数据的副本（每个保存数据库完整数据集的节点称之为副本）。数据复制方案的好处: 
* 提供冗余，提高可用性：如果某些节点发生不可用，则可以通过其他节点继续提供数据访问服务。
* 扩展至多台机器以同时提供数据访问服务，从而提高读吞吐量
* 使数据在地理位置上更接近用户，从而降低访问延迟。

当有了多副本，不可避免地会引人一个问题：如何确保所有副本之间的数据是一致的？针对持续更改的数据，有三种流行的复制数据变化的方法：主从复制、多主节点复制和无主节点复制。几乎所有的分布式数据库都使用上述方法中的某一种，而三种方法各有优缺点。

复制技术存在许多需要折中考虑的地方，例如采用同步复制还是异步复制，以及如何处理失败的副本等。数据库通常采用可配置选项来调整这些处理策略，虽然在处理细
节方面因数据库实现而异，但存在一些通用的一般性原则。

###### 主从复制
主从复制的工作原理如下：
1. 指定某一个副本为主副本（或称为主节点）。当客户写数据库时，必须将写请求首先发送给主副本，主副本首先将新数据写入本地存储。
2. 其他副本则全部称为从副本。主副本把新数据写入本地存储后，然后将数据更改作为复制的日志或更改流发送给所有从副本。每个从副本
获得更改日志之后将其应用到本地，且严格保持与主副本相同的写入顺序。
3. 客户端从数据库中读数据时，可以在主副本或者从副本上执行查询。再次强调，只有主副本才可以接受写请求：从客户端的角度来看，从副本都是只读的。

复制方式分为三种:
1. 同步复制：主节点需等待直到从节点确认完成了写入才返回完成。优点是， 一旦向用户确认，从节点可以明确保证完成了与主节点的更新同步，数据已经处于最新版本
2. 异步复制：主节点发送完消息之后立即返回，不用等待从节点的完成确认。优点是，不管从节点上数据多么滞后， 主节点总是可以继续响应写请求，系统的吞吐性能更好。
3. 半同步复制：其中某一个从节点是同步的，而其他节点则是异步模式，可以保证至少有两个节点（即主节点和一个同步从节点）拥有最新的数据副本


配置新的从节点的主要操作步骤如下：
1. 在某个时间点对主节点的数据副本产生一个一致性快照。
2. 将此快照拷贝到新的从节点。
3. 从节点连接到主节点并请求快照点之后所发生的数据更改日志。
4. 获得日志之后，从节点来应用这些快照点之后所有数据变更，这个过程称之为追赶。

处理节点失效：
* 从节点失效，追赶式恢复：根据副本的复制日志，从节点可以知道在发生故障之前所处理的最后一笔事务，然后连接到主节点，并请求自那笔事务之后中断期间内所有的数据变更。在收到这些数据变更日志之后，将其应用到本地来追赶主节点。
* 主节点失效，节点切换：：选择某个从节点将其提升为主节点，之后的写请求会发送给新的主节点，然后其他从节点要接受来自新的主节点上的变更数据，这一过程称之为切换。

主节点自动切换的步骤通常如下：
1. 确认主节点失效：大多数系统都采用了基于超时的机制，节点间频繁地互相发送心跳存活消息，如果发现某一个节点在一段比较长时间内（例如30s ）没有响应，即认为该节点发生失效
2. 选举新的主节点：可以通过选举的方式（超过多数的节点达成共识）来选举新的主节点，或者由之前选定的某控制节点来指定新的主节点。候选节点最好与原主节点的数据差异最小，这样可以最小化数据丢失的风险
3. 重新配置系统使新主节点生效：如果原主节点之后重新上线，可能仍然自认为是主节点，而没有意识到其他节点已经达成共识迫使其下台。这时系统要确保原主节点降级为从节点，并认可新的主节点。

主节点自动切换过程中的难点：
1. 如果使用了异步复制，且失效之前，新的主节点并未收到原主节点的所有数据；在选举之后，原主节点很快又重新上线并加入到集群，接下来的写操作会发生什么？新的主节点很可能会收到冲突的写请求，这是因为原主节点未意识的角色变化，还会尝试同步其他从节点，但其中的一个现在已经接管成为现任主节点。常见的解决方案是，原主节点上未完成复制的写请求就此丢弃，但这可能会违背数据更新持久化的承诺。
2. 如何设置合适的超时来检测主节点失效呢？主节点失效后，超时时间设置得越长也意味着总体恢复时间就越长。但如果超时设置太短，可能会导致很多不必要的切换。例如，突发的负载峰值会导致节点的响应时间变长甚至超肘，或者由于网络故障导致延迟增加。如果系统此时已经处于高负载压力或网络已经出现严重拥塞，不必要的切换操作只会使总体情况变得更糟。

> 在某些故障情况下，可能会发生两个节点同时都自认为是主节点。这种情况被称为脑裂，它非常危险：两个主节点都可能接受写请求，并且没有很好解决冲突的办法，最后数据可能会丢失或者破坏。

复制日志的实现:
1. 基于语句的复制：主节点记录所执行的每个写请求（操作语句）并将该操作语句作为日志发送给从节点。
2. 基于预写日志（ WAL) 传输: 
3. 基于行的逻辑日志复制
4. 基于触发器的复制

基于语句的复制的问题：
1. 任何调用非确定性函数的语句，如 NOW（）获取当前时间，或 RAND（）获取一个随机数等，可能会在不同的副本上产生不同的值。
2. 如果语句中使用了自增列，或者依赖于数据库的现有数据（例如，UPDATE WHERE ＜某些条件＞），则所有副本必须按照完全相同的顺序执行，否则可能会带来不同的结果。进而，如果有多个同时并发执行的事务时，会有很大的限制。
3. 有副作用的语句（例如，触发器、存储过程、用户定义的函数等），可能会在每个副本上产生不同的副作用。
   
复制滞后问题:


## 扩展性
当数据量或者读写负载巨大，严重超出了单台机器的处理上限，需要将负载分散到多台机器上。从单机的数据存储转向跨机器的分布式系统，这是扩展性的重要一步。系统扩展方式分为两种:
* 垂直扩展（即升级到更强大的机器，有共享体系架构）：例如共享内存架构、共享磁盘架构
* 水平扩展（即将负载分布到多个更小的机器，无共享体系架构）：每个节点独立使用本地的CPU、内存和磁盘。节点之间的所有协调通信等任务全部运行在传统网络（以太网）之上且核心逻辑主要依靠软件来实现。

> 共享内存架构的问题在于，成本增长过快甚至超过了线性：即如果把一台机器内的 CPU 数量增加一倍，内存扩容一倍，磁盘容量加大一倍，则最终总成本增加不止一
倍。井且由于性能瓶颈因素，这样一台机器尽管拥有了两倍的硬件指标但却不一定能处理两倍的负载。

> 延迟考虑: 如果客户遍布世界各地，通常需要考虑在全球范围内部署服务，以方便用户就近访问最近数据中心所提供的服务，从而避免数据请求跨越了半个地球才能到达目标。
#### 数据扩展方案-分区
将一个大块头的数据库拆分成多个较小的子集即分区，不同的分区分配给不同的节点（也称为分片）。「分布式存储系统」对数据分区一般有两种方式：Hash 分区和 Range 分区。Range 分区能够支持更丰富的访问模式，使用起来更加灵活。

* Hash 分区对每条数据算一个哈希值，映射到一个逻辑分区上，然后通过另外一层映射将逻辑分区映射到具体的机器上，很多数据库中间件、缓存中间件都是这样做的。这种方式的优点是数据写入一般不会出现热点，缺点是原本连续的数据经过Hash后散落在不同的分区上变成了无序的，那么，如果需要扫描一个范围的数据，需要把所有的分区都扫描一遍。

* Range分区对数据进行范围分区，连续的数据是存储在一起的，可以按需对相邻的分区进行合并，或者中间切一刀将一个分区一分为二。业界典型的系统像HBase。这种分区方式的缺点是一、对于追加写处理不友好，因为请求都会打到最后一个分片，使得最后一个分片成为瓶颈。优点是更容易处理热点问题，当一个分区过热的时候，可以切分开，迁移到其他的空闲机器上。






## 参考文献
[字节跳动自研强一致在线 KV &表格存储实践-上篇](https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247485932&idx=1&sn=28394ff3b8ac272852f22105c3768d0f&chksm=e9d0c20edea74b18d6d8eaa0720c52351b4bfaeb0ebde24e08db4c899012d2ad90c2aa977806&token=911418867&lang=zh_CN&scene=21#wechat_redirect)

[字节跳动自研强一致在线 KV &表格存储实践-下篇](https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247485942&idx=1&sn=01192ff69299de3a007de789ac84564b&chksm=e9d0c214dea74b0245c5d4ac0854d23a113ccc55e3ee042fc1239e14d5860817f1d88fc9befa&token=1461619284&lang=zh_CN#rd)

[推荐一个raft算法的动画演示，便于理解，感觉挺好玩的！](http://thesecretlivesofdata.com/raft/)

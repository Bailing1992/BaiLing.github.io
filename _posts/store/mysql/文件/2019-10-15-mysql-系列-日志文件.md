---
layout: post
title: "MySQL 系列 日志文件"
subtitle: 'MySQL 技术内幕：InnoDB存储引擎'
author: "lichao"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
  - MySQL
---

> 日志是 MySQL 数据库的重要组成部分。日志文件中记录着 MySQL 数据库运行期间发生的变化，也就是说用来记录 MySQL 数据库的客户端连接状况、SQL 语句的执行情况和错误信息等。当数据库遭到意外的损坏时，可以通过日志查看文件出错的原因，并且可以通过日志文件进行数据恢复。

MySQL 整体来看，其实就有两块：一块是 Server 层，它主要做的是 MySQL 功能层面的事情；还有一块是引擎层，负责存储相关的具体事宜。redo log 是 InnoDB 引擎特有的日志，而 Server 层也有自己的日志，称为 binlog（归档日志）。

在 MySQL 中，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。MySQL 使用 WAL 技术来提升更新效率，WAL 的全称是 ```Write-Ahead Logging```，它的关键点就是先写日志，再写磁盘。具体来说，当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到```redo log```里面，并更新内存，这个时候更新就算完成了。同时，InnoDB 引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做。

有了 Redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为 **crash-safe**。

因为最开始 MySQL 里并没有 InnoDB 引擎。MySQL 自带的引擎是 MyISAM，但是 MyISAM 没有 crash-safe 的能力，binlog 日志只能用于归档。而 InnoDB 是另一个公司以插件形式引入 MySQL 的，既然只依靠 binlog 是没有 crash-safe 能力的，所以 InnoDB 使用另外一套日志系统——也就是 redo log 来实现 crash-safe 能力。

这两种日志有以下三点不同: 
* redo log 是 InnoDB 引擎特有的。binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用。
* redo log 是物理日志，记录的是“在某个数据页上做了什么修改”；binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如 “给 ID = 2 这一行的 c 字段加 1”。
* redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的。“追加写”是指 binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。

> 在主从复制结构中，要保证事务的持久性和一致性，需要对日志相关变量设置为如下：
* 如果启用了二进制日志，则设置 ```sync_binlog = 1```，即每提交一次事务同步写到磁盘中。
* 总是设置 ```innodb_flush_log_at_trx_commit = 1```，即每提交一次事务都写到磁盘中。


[详情请看-bin log](https://bailing1992.github.io/2020/05/25/mysql-%E7%B3%BB%E5%88%97-bin-log/)

[详情请看-redo log](https://bailing1992.github.io/2020/05/25/mysql-%E7%B3%BB%E5%88%97-redo-log/)

## 两阶段提交

## 其他日志
#### 错误日志
* 记录 MySQL 的启动、运行、关闭过程。   
* 记录所有的错误信息，也记录一些警告信息或正确的信息。
* 记录有关数据库优化的警告信息
#### 慢查询日志
慢查询会导致 CPU，IOPS，内存消耗过高。当数据库遇到性能瓶颈时，大部分时间都是由于慢查询导致的。 开启慢查询日志，可以让 MySQL 记录下查询超过指定时间的语句，之后运维人员通过定位分析，能够很好的优化数据库性能。

慢查询日志记录的慢查询不仅仅是执行比较慢的 SELECT 语句，还有 INSERT，DELETE，UPDATE，CALL 等 DML 操作，只要超过了指定时间，都可以称为"慢查询"，被记录到慢查询日志中。

默认情况下，慢查询日志是不开启的，只有手动开启了，慢查询才会被记录到慢查询日志中。

开启慢查询日志后，MySQL 数据库会记录运行时间超过 ```long_query_time``` 阈值的所有 sql 语句。
打开```log_queries_not_using_indexes```后，如果执行 SQL 没有使用索引，MySQL 同样会将 SQL 语句记录到慢查询日志文件中。
#### 查询日志
记录了所有对 MySQL 数据库请求的信息，无论这些请求是否得到了正确的执行，默认文件名为：“主机名.log”，记录包括访问拒绝的请求。

查询日志在 MySQL 中被称为 general log(通用日志)，查询日志里的内容不要被“查询日志”误导，认为里面只存储 select 语句，其实不然，查询日志里面记录了数据库执行的所有命令，不管语句是否正确，都会被记录，默认文件名为：“主机名.log”，记录包括访问拒绝的请求。具体原因如下:
* insert 为了避免数据冲突需要首先查询。如果此前插入过数据，当前插入的数据如果跟主键或唯一键的数据重复那肯定会报错
* update 时也会查询因为更新的时候很可能会更新某一块数据
* delete 查询，只删除符合条件的数据

因此都会产生日志，在并发操作非常多的场景下，查询信息会非常多，那么如果都记录下来会导致 IO 非常大，影响 MySQL性能，因此如果不是在调试环境下，是不建议开启查询日志功能的。

查询日志的开启有助于帮助我们分析哪些语句执行密集，执行密集的 Select 语句对应的数据是否能够被缓存，同时也可以帮助我们分析问题，所以，我们可以根据自己的实际情况来决定是否开启查询日志。
## 参考文献
[知乎](https://zhuanlan.zhihu.com/p/58011817)
[知乎](https://jkzhao.github.io/2018/04/16/MySQL%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3/)

http://go.fire80.com/Detail/article/id/78.html
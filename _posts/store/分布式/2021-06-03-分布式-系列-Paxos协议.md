---
layout: post
title: "分布式 系列 Paxos协议"
author: "lichao"
header-img: "img/post/bg/post-bg-distance.png"
catalog: true
tags:
  - distribute
---

Paxos算法是Lamport提出的一种基于消息传递的分布式一致性算法。

> 其中提出了一个问题：
>
> 在古希腊有一个叫做Paxos的小岛，岛上采用议会的形式来通过法令，议会中的议员通过信使进行消息的传递。值得注意的是，议员和信使都是兼职的，议员随时有可能会离开议会厅，并且信使可能会重复的传递消息，也可能一去不复返。因此，议会协议要保证在这种情况下法令仍然能够正确的产生，并且不会出现冲突。
>
> Paxos算法不是为了解决拜占庭将军问题的。
> 首先，拜占庭将军问题描述的是从理论上来说，在分布式计算领域，试图在异步系统和不可靠的通道上来达到一致性状态是不可能的。
> 因此在对一致性的研究过程中，都往往假设信道是可靠的。
>
> - 在工程实践中，大多数系统都是部署在同一个局域网中的，因此消息被篡改的情况非常罕见；
> - 另一方面，由于硬件和网络原因而造成的消息不完整问题，只需要通过简单的校验算法即可避免。
> 因此，在实际工程实践中，可以假设不存在拜占庭将军问题，也就是说可以假设所有消息都是完整的，没有被篡改。
> 而Paxos算法是基于没有拜占庭问题的假设下进行的。

## 算法流程

### 三种角色

Paxos将系统中的角色分为提议者 (Proposer)，接受者 (Acceptor)，和学习者 (Learner)，它们之间的关系如下：
![paxos](/img/distributed/paxos角色.png){:height="80%" width="80%"}

- **提议者 (Proposer)**：提议一个值，用于投票表决。在绝大多数场景中，集群中收到客户端请求的节点，就是提议者。
- **接受者 (Acceptor)**：对每个提议的值进行投票，并存储接受的值。一般来说，集群中的所有节点都在扮演接受者的角色，参与共识协商，并接受和存储数据。
- **学习者 (Learner)**：被告知投票的结果，接受达成共识的值，存储保存，不参与投票的过程，一般来说，学习者是数据备份节点，比如“Master-Slave”模型中的Slave，被动地接受数据，容灾备份。

> 系统中的节点可以身兼多个角色。
>
> 针对这三种角色，本质上代表的是三种功能：
>
> - 提议者代表接入和协调功能，收到客户端请求后，发起二阶段提交，进行共识协商
> - 接受者代表投票协商和存储数据，对提议的值进行投票，并接受达成共识的值，存储数据；
> - 学习者代表存储数据，不参与共识协商，只接受达成共识的值，存储保存。

### Basic Paxos

> Paxos分准备阶段和批准阶段两个阶段完成，每个阶段后还需要判断该阶段的结果是否有效是否需要重来，另外需要注意提案编号全局递增且唯一。
> 注意：Basic Paxos只用于单值的共识，一旦这个值确定之后就不会再发生变化了。因此，在工程中是不会使用这个算法的，该算法一般用于科学研究。

算法步骤：

- 阶段一：prepare准备阶段（只需携带提案ID）
  1. 获取一个提案ID K，为了保证提案ID唯一并且是递增的，可采用时间戳+Server ID生成；
  2. Proposer向所有Acceptors广播Prepare(K)请求；
  3. Acceptor收到Prepare请求会有以下三种情况：
     1. 情况1：Acceptor从未承诺（promise）过提案（即MaxNet==null），Acceptor记录最大提案编号MaxN为K，回应 ok
     2. 情况2：提案编号K < Acceptor的最大提案编号MaxN，不回应或回应错误提醒
     3. 情况3：提案编号K > Acceptor的最大提案编号MaxN，Acceptor记录最大提案编号MaxN为K，回应ok。如果已经接受过提案，则将接受过的提案编号和值（AcceptN和AcceptV）一并回复
     4. 如果Proposer收到超过半数的ok，则进入批准阶段，否则重新回到准备阶段
- 阶段二：批准阶段（携带提案ID和值）

  1. Proposer向所有回复ok的Acceptor发送accept请求，包括编号K和上一阶段拿到的最大的AcceptN 所对应的 AcceptV（如果没有已经接受的value，那么它可以自由决定value）。
  2. Acceptor收到accept请求，会有以下两种情况：
     1. 情况1：提案编号K < Acceptor的最大提案编号 MaxN，不回应或回应错误提醒
     2. 情况2：提案编号K >= Acceptor的最大提案编号 MaxN，批准请求，回应 ok，记录AcceptN=K，AcceptV=value（如果之前已经有AcceptN和AcceptV，这个时候也会覆盖！）
  3. 如果Proposer收到超过半数的ok，则选举结束，将结果通知给 Learner，否则重新回到准备阶段
